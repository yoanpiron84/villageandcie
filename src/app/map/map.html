<div id="map-container" class="map-container"></div>

<!-- Recherche -->
<div class="search-container">
  <input
    type="text"
    placeholder="Rechercher un lieu..."
    [(ngModel)]="searchService.searchTerm"
    (input)="onSearchInput($event)"
    (blur)="onSearchBlur()"
  />
  <span class="search-icon">üîç</span>

  <!-- Liste autocomplete -->
  <ul class="dropdown" *ngIf="searchService.showDropdown">
    <li *ngFor="let result of searchService.searchResults" (click)="selectResult(result)">
      {{ result.display_name }}
    </li>
  </ul>

  <!-- Vue map -->
  <button class="toggle-view-btn" (click)="toggleViewOptions()">üåç</button>
  <div class="view-options-card" *ngIf="showViewOptions">
    <div class="view-option" (click)="interactionService.setMapView('satellite')">
      <img src="/images/satellite.png" alt="Satellite" />
      <span>Satellite</span>
    </div>
    <div class="view-option" (click)="interactionService.setMapView('osm')">
      <img src="/images/osm.png" alt="OSM" />
      <span>OSM</span>
    </div>
  </div>

  <!-- Pin -->
  <button class="toggle-pin-btn" [class.active]="interactionService.isPinModeActive" (click)="interactionService.togglePinMode()">üìç</button>
</div>

<!-- Boutons et panneau itin√©raire -->
<div class="map-controls">
  <!-- Bouton principal Itin√©raire -->
  <button (click)="toggleRouteMode()">
    {{ routeService.isRouteModeActive ? (translations['route_cancel'] || 'Annuler Itin√©raire') : (translations['route_start'] || 'Itin√©raire') }}
  </button>

  <!-- Bouton pour afficher la carte des √©tapes -->
  <button *ngIf="routeService?.routeInfo" class="toggle-steps-btn" (click)="routeService.showStepsCard = !routeService.showStepsCard">
    üß≠ {{ routeService.showStepsCard ? translations['hide_steps'] || 'Cacher √©tapes' : translations['show_steps'] || 'Voir √©tapes' }}
  </button>

  <!-- S√©lecteur de mode -->
  <select [(ngModel)]="routeService.routeMode" (change)="setRouteMode(routeService.routeMode)">
    <option value="routed-car">{{ translations['routed_car'] || 'Voiture' }}</option>
    <option value="routed-foot">{{ translations['routed_foot'] || '√Ä pied' }}</option>
    <option value="routed-bike">{{ translations['routed_bike'] || 'V√©lo' }}</option>
  </select>
</div>

<!-- üß≠ Carte d√©roulante des √©tapes -->
<div class="steps-card" *ngIf="routeService.showStepsCard && routeService.routeInfo?.steps?.length">
  <div class="steps-header">
    <h3>üó∫Ô∏è {{ translations['route_details'] || "D√©tails de l‚Äôitin√©raire" }}</h3>
    <button class="close-btn" (click)="routeService.showStepsCard = false">‚úñ</button>
  </div>

  <div class="steps-list">
    <div *ngFor="let step of routeService.routeInfo?.steps; let i = index" class="step-item">
      <div class="step-number">{{ i + 1 }}</div>
      <div class="step-text">
        <strong>{{ translations['maneuver_' + (step.maneuver?.type || 'unknown')] || (step.maneuver?.type | titlecase) }}</strong>
        <span *ngIf="step.maneuver?.modifier">
          {{ ' ' + (translations['modifier_' + step.maneuver.modifier] || step.maneuver.modifier) }}
        </span>
        <span *ngIf="step.name"> {{ translations['on'] || 'sur' }} {{ step.name }}</span>
        <br />
        <small>{{ step.distance | number:'1.0-0' }} {{ translations['meters'] || 'm' }}</small>
      </div>
    </div>
  </div>
</div>

<div class="route-panel" *ngIf="routeService.routeInfo as r">
  <div>{{ translations['total_distance'] || 'Distance totale' }} : {{ (r.distance ?? 0) / 1000 | number:'1.1-1' }} {{ translations['km'] || 'km' }}</div>
  <div>{{ translations['total_duration'] || 'Dur√©e totale' }} : {{ (r.duration ?? 0) / 60 | number:'1.0-0' }} {{ translations['minutes'] || 'min' }}</div>

  <ul *ngIf="r.steps?.length; else noSteps">
    <li *ngFor="let step of r.steps">
      {{ translations['maneuver_' + (step.maneuver?.type || 'unknown')] || (step.maneuver?.type | titlecase) }}
      <span *ngIf="step.maneuver?.modifier">
        {{ ' ' + (translations['modifier_' + step.maneuver.modifier] || step.maneuver.modifier) }}
      </span>
      <span *ngIf="step.name"> {{ translations['on'] || 'sur' }} {{ step.name }}</span>
      ({{ step?.distance ?? 0 | number:'1.0-0' }} {{ translations['meters'] || 'm' }})
    </li>
  </ul>

  <ng-template #noSteps>
    <li>{{ translations['no_steps'] || 'Aucune √©tape disponible.' }}</li>
  </ng-template>
</div>

<!-- Localisation -->
<button class="btn-localisation"
        [ngClass]="{'activetoinactive-localisation': interactionService.isLocalisationActive, 'inactivetoactive-localisation': !interactionService.isLocalisationActive}"
        (click)="interactionService.toggleLocalisation(currentLanguage)">
  {{ interactionService.isLocalisationActive ? translations['disable_location'] || 'D√©sactiver ma localisation' : translations['enable_location'] || 'Activer ma localisation' }}
</button>

@if(layerService.activeLayers.size > 0) {
  <!-- Filtre -->
  <button class="toggle-filter-btn" (click)="layerService.toggleFilterCard()">
    <i class="fa fa-filter"></i>
  </button>

  <div class="filter-card" *ngIf="layerService.showFilterCard">
    <h4>Filtrer par couche</h4>
    <div class="select-wrapper">
      <select [(ngModel)]="layerService.selectedLayerAction" (ngModelChange)="layerService.currentRadius = layerService.layerRadii[$event] || 1">
        <option *ngFor="let action of layerService.activeLayers" [value]="action">{{ this.layerService.layerLabels[action] }}</option>
      </select>
      <span class="select-arrow">‚ñº</span>
    </div>

    <h4>Filtrer par rayon</h4>
    <input #radiusSlider
           type="range"
           min="1"
           max="10"
           step="0.5"
           [value]="layerService.currentRadius"
           (change)="layerService.applyFilter($any($event.target).valueAsNumber)"
           [disabled]="!layerService.canApplyFilter"
           [ngClass]="{'disabled-btn': !layerService.canApplyFilter}" />
    <div class="radius-value">{{ layerService.currentRadius || layerService.layerRadii[layerService.selectedLayerAction] || 1 }} km</div>

    <div class="filter-actions">
      <div *ngIf="mapService.waitingMessage">{{ mapService.waitingMessage }}</div>
    </div>

  </div>
}
