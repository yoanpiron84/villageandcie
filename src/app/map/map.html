<app-edit-form
  *ngIf="interactionService.showModal"
  [name]="interactionService.modalName"
  [tags]="interactionService.modalTags"
  (ok)="onModalOk($event)"
  (cancel)="onModalCancel()">
</app-edit-form>


<app-add-form
  *ngIf="showAddForm && newPointCoords"
  [coords]="newPointCoords"
  (cancel)="showAddForm = false">
</app-add-form>

<div class="routine-modal-backdrop" *ngIf="showRoutineModal">
  <div class="routine-modal">

    <h3>Que voulez-vous faire maintenant ?</h3>

    <label>
      <input type="checkbox" [(ngModel)]="routineChoices.manger" />
      ğŸ½ï¸ Manger
    </label>

    <label>
      <input type="checkbox" [(ngModel)]="routineChoices.boire" />
      ğŸº Boire
    </label>

    <label>
      <input type="checkbox" [(ngModel)]="routineChoices.dormir" />
      ğŸ›ï¸ Dormir
    </label>

    <label>
      <input type="checkbox" [(ngModel)]="routineChoices.culte" />
      â›ª Culte
    </label>

    <label>
      <input type="checkbox" [(ngModel)]="routineChoices.evenements" />
      ğŸ­ Ã‰vÃ©nements
    </label>

    <div class="routine-alert" *ngIf="!selectedCity">
      Veuillez sÃ©lectionner une ville avant de valider.
    </div>

    <div class="actions">
      <button (click)="applyRoutine()" [disabled]="!selectedCity">Afficher</button>
      <button class="cancel" (click)="closeRoutineModal()">Annuler</button>
    </div>


  </div>
</div>


<div id="map-container" class="map-container">

  <!-- Carte en premier -->
  <div #mapHost id="map" class="map-host">

    <!-- Recherche -->
    <div class="search-container">

      <input
        type="text"
        placeholder="Rechercher un lieu..."
        [(ngModel)]="searchService.searchTerm"
        (input)="onSearchInput($event)"
        (blur)="onSearchBlur()"
      />
      <span class="search-icon">ğŸ”</span>

      <!-- Liste autocomplete -->
      <ul class="dropdown" *ngIf="searchService.showDropdown">
        <li *ngFor="let result of searchService.searchResults" (click)="selectResult(result)">
          {{ result.display_name }}
        </li>
      </ul>

      <!-- Vue map -->
      <button class="toggle-view-btn" (click)="toggleViewOptions()">ğŸŒ</button>
      <div class="view-options-card" *ngIf="showViewOptions">
        <div class="view-option" (click)="interactionService.setMapView('satellite')">
          <img src="/images/satellite.png" alt="Satellite" />
          <span>Satellite</span>
        </div>
        <div class="view-option" (click)="interactionService.setMapView('osm')">
          <img src="/images/osm.png" alt="OSM" />
          <span>OSM</span>
        </div>
      </div>

      <!-- Pin -->
      <button class="toggle-pin-btn" [class.active]="interactionService.isPinModeActive" (click)="interactionService.togglePinMode()">ğŸ“</button>
    </div>

    <!-- Boutons et panneau itinÃ©raire -->
    <div class="map-controls" [class.panel-open]="isPanelOpen">
      <!-- Bouton principal ItinÃ©raire -->
      <button (click)="toggleRouteMode()">
        {{ routeService.isRouteModeActive ? (translations['route_cancel'] || 'Annuler ItinÃ©raire') : (translations['route_start'] || 'ItinÃ©raire') }}
      </button>

      <!-- Bouton pour afficher la carte des Ã©tapes -->
      <button *ngIf="routeService?.routeInfo" class="toggle-steps-btn" (click)="routeService.showStepsCard = !routeService.showStepsCard">
        ğŸ§­ {{ routeService.showStepsCard ? 'Cacher Ã©tapes' : 'Voir Ã©tapes' }}
      </button>

      <!-- SÃ©lecteur de mode -->
      <select [(ngModel)]="routeService.routeMode" (change)="setRouteMode(routeService.routeMode)">
        <option value="routed-car">{{ translations['routed_car'] || 'Voiture' }}</option>
        <option value="routed-foot">{{ translations['routed_foot'] || 'Ã€ pied' }}</option>
        <option value="routed-bike">{{ translations['routed_bike'] || 'VÃ©lo' }}</option>
      </select>

      <button class="add-btn" (click)="startAddMode()" aria-label="Ajouter un point">+</button>
    </div>

    <!-- ğŸ§­ Carte dÃ©roulante des Ã©tapes -->
    <div class="steps-card" *ngIf="routeService.showStepsCard && routeService.routeInfo?.steps?.length">
      <div class="steps-header">
        <h3>ğŸ—ºï¸ {{ translations['route_details'] || "DÃ©tails de lâ€™itinÃ©raire" }}</h3>
        <button class="close-btn" (click)="routeService.showStepsCard = false">âœ–</button>
      </div>

      <div class="steps-list">
        <div *ngFor="let step of routeService.routeInfo?.steps | slice:1; let i = index" class="step-item">
          <div class="step-number">{{ i + 1 }}</div>
          <div class="step-text">
            <strong>
              {{ translations['maneuver_' + (step.maneuver?.type || 'unknown')] || (step.maneuver?.type | titlecase) }}
            </strong>
            <span *ngIf="step.maneuver?.modifier">
        {{ ' ' + (translations['modifier_' + step.maneuver.modifier] || step.maneuver.modifier) }}
      </span>
            <span *ngIf="step.name"> {{ translations['on'] || 'sur' }} {{ step.name }}</span>
            <br />
            <small>
              Distance de l'Ã©tape : {{ step.distance | number:'1.0-0' }} {{ translations['meters'] || 'm' }}
              <span *ngIf="routeService.routeInfo!.steps[i]">
          | ArrivÃ©e Ã  l'Ã©tape dans : {{ routeService.routeInfo!.steps[i].distance | number:'1.0-0' }} {{ translations['meters'] || 'm' }}
        </span>
            </small>
          </div>
        </div>
      </div>

    </div>

    <!-- BOUTON ROUTINE -->
    <button class="routine-btn" (click)="openRoutineModal()" aria-label="Autour de moi">
      ğŸ§­
    </button>

    <!-- Localisation -->
    <button class="btn-localisation" [class.panel-open]="isPanelOpen"
            [ngClass]="{'activetoinactive-localisation': interactionService.isLocalisationActive, 'inactivetoactive-localisation': !interactionService.isLocalisationActive}"
            (click)="interactionService.toggleLocalisation(this.languageService.currentLanguage)">
      {{ interactionService.isLocalisationActive ? 'DÃ©sactiver ma localisation' : 'Activer ma localisation' }}
    </button>

    @if(layerService.activeLayers.size > 0) {
      <!-- Filtre -->
      <button class="toggle-filter-btn" [class.panel-open]="isPanelOpen" (click)="layerService.toggleFilterCard()">
        <i class="fa fa-filter"></i>
      </button>

      <div class="filter-card" *ngIf="layerService.showFilterCard" [class.panel-open]="isPanelOpen">
        <h4>Filtrer par couche</h4>
        <div class="select-wrapper">
          <select [(ngModel)]="layerService.selectedLayerAction" (ngModelChange)="layerService.currentRadius = layerService.layerRadii[$event] || 0.5">
            <option *ngFor="let action of layerService.activeLayers" [value]="action">{{ this.layerService.layerLabels[action] }}</option>
          </select>
          <span class="select-arrow">â–¼</span>
        </div>

        <h4>Filtrer par rayon</h4>
        <input #radiusSlider
               type="range"
               min="0.5"
               max="1.5"
               step="0.5"
               [value]="layerService.currentRadius"
               (change)="layerService.applyFilter($any($event.target).valueAsNumber)"
               [disabled]="!layerService.canApplyFilter"
               [ngClass]="{'disabled-btn': !layerService.canApplyFilter}" />
        <div class="radius-value">{{ layerService.currentRadius || layerService.layerRadii[layerService.selectedLayerAction] || 0.5 }} km</div>

        <div class="filter-actions">
          <div *ngIf="mapService.waitingMessage">{{ mapService.waitingMessage }}</div>
        </div>

      </div>

    }
  </div>

  <!-- Panneau Ã  DROITE -->
  <div #sidebarPanel class="side-panel">
    <button class="close-btn" (click)="closePanel()">Ã—</button>
    <div #sidebarContent class="panel-content">
      <div class="tooltip-card">
        <!-- titre et type directement injectÃ©s par ton innerHTML ou bindings -->
        <div class="card-header" [innerHTML]="tooltipHeader"></div>

        <div class="tags-container" [innerHTML]="tooltipTags"></div>

      </div>
    </div>
  </div>





</div>

